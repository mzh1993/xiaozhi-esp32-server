# 启动文档

本文记录 2025-11-07 在本地以源码方式运行智控台全模块（manager-api、manager-web、Python `xiaozhi-server`）的完整步骤，便于后续快速复现环境。

## 1. 环境准备

### 1.1 Conda 与 Python 依赖

```bash
conda create -n xiaozhi-esp32-server python=3.10 -y
conda install -n xiaozhi-esp32-server libopus ffmpeg -y
/home/neousys/anaconda3/envs/xiaozhi-esp32-server/bin/pip install -r main/xiaozhi-server/requirements.txt
```

> 说明：`pip` 使用了阿里云镜像，`requirements.txt` 会拉取 FunASR、Torch 等大体量包，安装时间较长。

### 1.2 Node.js、JDK、Maven

- Node.js：已安装 v22.14.0，可直接运行 `npm install && npm run serve`
- JDK：系统自带 `openjdk-21`
- Maven：系统自带 `mvn 3.6.3`，与 Spring Boot 3.4.3 兼容

## 2. 数据库与 Redis

- MySQL 服务已运行（`systemctl status mysql`）
- 创建数据库：

```bash
mysql -h127.0.0.1 -uroot -p123456 -e "CREATE DATABASE IF NOT EXISTS xiaozhi_esp32_server CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
```

- Redis 已通过 `redis-cli ping` 验证在线，无需额外操作

### 2.1 数据库结构初始化

启动 `manager-api` 后，项目自带的 Liquibase 会自动执行 `src/main/resources/db/changelog/db.changelog-master.yaml`，创建所有 `sys_*/ai_*` 相关表。可通过 `mysql ... SHOW TABLES;` 验证。

## 3. 配置说明

### 3.1 本地配置文件

复制默认 API 配置模板：

```bash
cd main/xiaozhi-server
mkdir -p data
cp config_from_api.yaml data/.config.yaml
```

并写入实际参数（当前已配置如下）：

```yaml
server:
  vision_explain: http://127.0.0.1:8003/mcp/vision/explain
manager-api:
  url: http://127.0.0.1:8002/xiaozhi
  secret: 26601e9e-adf9-4bf6-b948-c5d25a70c19d
```

> `secret` 来源：`SELECT param_value FROM sys_params WHERE param_code='server.secret';`

### 3.2 管理后台必要参数

为保证设备能获取正确地址，在 `sys_params` 中写入：

```sql
UPDATE sys_params SET param_value='ws://192.168.31.166:8000/xiaozhi/v1/' WHERE param_code='server.websocket';
UPDATE sys_params SET param_value='http://192.168.31.166:8002/xiaozhi/ota/' WHERE param_code='server.ota';
```

### 3.3 默认管理员账号

直接在数据库插入超级管理员（用户名/密码：`admin/admin`，密码是 BCrypt 哈希）：

```sql
INSERT INTO sys_user (id, username, password, super_admin, status, create_date)
VALUES (
  1,
  'admin',
  '$2a$10$EDUIA2RuOI5hsobZ.b/38u/s.a8EgcI10F9ZR8J14Ut6g4qPEZ.LO',
  1,
  1,
  NOW()
)
ON DUPLICATE KEY UPDATE
  password=VALUES(password),
  super_admin=VALUES(super_admin),
  status=VALUES(status);
```

初次登录后请在智控台中立即修改密码。

## 4. 启动顺序与命令

* **管理后端（manager-api）**

  ```bash
  cd main/manager-api
  mvn spring-boot:run
  ```

  - 默认监听 `8002`
  - Swagger 地址：`http://127.0.0.1:8002/xiaozhi/doc.html`
* **管理前端（manager-web）**

  ```bash
  cd main/manager-web
  npm install
  npm run serve
  ```

  - Vite 开发服务监听 `8001`
  - 智控台入口：`http://127.0.0.1:8001`
* **Python 服务（xiaozhi-server）**

  ```bash
  cd main/xiaozhi-server
  /home/neousys/anaconda3/envs/xiaozhi-esp32-server/bin/python app.py \
    > /tmp/xiaozhi-server.log 2>&1 &
  ```

  - WebSocket：`ws://192.168.31.166:8000/xiaozhi/v1/`
  - HTTP（视觉/OTA）：`http://192.168.31.166:8003`

  启动日志示例：

  ```
  tail -f /tmp/xiaozhi-server.log
  ```

## 5. 验证步骤

1. 打开 `http://127.0.0.1:8001`，使用 `admin/admin` 登录
2. 在智控台“参数管理”中确认：

   - `server.secret` 与 `.config.yaml` 保持一致
   - `server.websocket`、`server.ota` 指向当前主机 IP/端口
3. `ss -tlnp | grep '8000\|8002\|8001'` 检查三项服务端口是否监听
4. 如果需要测试对话链路，可在浏览器打开 `main/xiaozhi-server/test/test_page.html`

   /home/neousys/anaconda3/envs/xiaozhi-esp32-server/bin/python -m http.server 8006

## 6. 日志与进程管理

| 服务           | 日志/查看命令               | 停止方式                             |
| -------------- | --------------------------- | ------------------------------------ |
| manager-api    | 控制台输出，或 `ps -ef      | grep AdminApplication`               |
| manager-web    | 控制台输出，或 `ps -ef      | grep "npm run serve"`                |
| xiaozhi-server | `/tmp/xiaozhi-server.log` | `pkill -f "xiaozhi-server/app.py"` |

常用调试指令：

```bash
# 查看最近日志
tail -n 200 /tmp/xiaozhi-server.log

# 实时跟踪日志
tail -f /tmp/xiaozhi-server.log

# 确认本地 Ollama 模型列表
OLLAMA_HOST=127.0.0.1:11434 ollama list

# 测试 Ollama 模型一句话
OLLAMA_HOST=127.0.0.1:11434 ollama run qwen2.5:1.5b "你好，介绍一下你自己"

# 检查服务进程
ps -ef | grep "python app.py"
```

## 7. 常见问题

- **Liquibase 命令报错找不到 `db/changelog/*.sql`**：直接通过 `mvn spring-boot:run` 启动即可自动迁移，不建议单独跑 `mvn liquibase:update`
- **Python 服务提示“请先配置 manager-api 的 secret”**：检查 `.config.yaml` 与 `sys_params` 中的 `server.secret` 是否一致
- **端口占用/服务未监听**：依次确认 8000（WS）、8001（前端）、8002（后端）、8003（Python HTTP）
- **测试页提示 “WebSocket错误: 未知错误” 或 “无法从OTA服务器获取信息”**：
  - 首先确认 Python 服务已启动，若仅本地调试且未启动 `manager-api`，请在测试页的 “OTA 服务器地址” 输入框中手动改为 `http://127.0.0.1:8003/xiaozhi/ota/`（或对应局域网 IP）。
  - 如果日志出现 `opening handshake failed` 或 `HTTP 500`，请更新到最新代码（已修复 websockets>=14 直接写 Header 造成的异常）。
  - 完成配置后重新点击 “连接”，应能拉取 OTA 配置并建立 WebSocket 会话。

## 8. 设备固件接入本地服务器

要让 ESP32 固件默认连接到本机部署的服务器，需要修改固件的 OTA 配置，使其在启动时向你的 OTA 接口拉取 WebSocket 参数。

### 8.1 修改 OTA 地址

1. 进入固件仓库 `xiaozhi-esp32`：

   ```bash
   cd /home/neousys/mzh/xiaozhi/xiaozhi-esp32
   ```
2. 执行 IDF 菜单配置，修改默认 OTA URL：

   ```bash
   idf.py menuconfig
   ```

   菜单路径：`Xiaozhi Assistant → Default OTA URL`

   将默认值改为你本地服务器的 OTA 接口，例如：

   ```
   http://192.168.31.166:8002/xiaozhi/ota/
   ```

   > 该地址就是 Python 服务 `OTAHandler` 暴露的接口，可在浏览器访问验证。
   >
3. 保存配置后退出（`Save → Exit`），IDF 会把新值写入 `sdkconfig`。
4. 如需固化到版本控制，可在 `sdkconfig` 稳定后，将其中的 `CONFIG_OTA_URL` 写入 `sdkconfig.defaults` 或直接修改 `main/Kconfig.projbuild` 的默认值。

### 8.2 编译与烧录

按照目标芯片选择 IDF target 并编译/烧录：

```bash
idf.py set-target esp32s3   # 根据开发板选取 esp32/esp32s3/esp32c3...
idf.py build
idf.py -p /dev/ttyUSB0 flash monitor
```

首次烧录后，设备会自动重启并执行下面流程。

### 8.3 设备上电后的联通流程

1. 设备启动后读取 `CONFIG_OTA_URL`，向 `http://192.168.31.166:8002/xiaozhi/ota/` 发起请求。
2. 服务器返回 JSON，默认为：
   ```json
   {
     "server_time": {...},
     "websocket": {
       "url": "ws://192.168.31.166:8000/xiaozhi/v1/",
       "token": "..."
     }
   }
   ```
3. 固件将 `websocket.url` 和 `websocket.token` 写入 NVS（`Settings("websocket", true)`）。
4. 语音会话开启时（唤醒或按键），使用存储的 URL 发起 WebSocket 连接，直接连到你的 Python 服务。

### 8.4 服务器参数变更

若服务器地址/端口调整：

1. 在 Java 管理端中更新 `sys_params` 的 `server.websocket`、`server.ota`；Python `.config.yaml` 里的 `server.websocket` 也要同步。
2. 固件保持旧 URL 也能继续访问 OTA 接口，但需要确保 OTA 接口本身地址未变；如需更换 OTA 域名/IP，则重新执行 **8.1** 修改 OTA URL 并重新烧录。

通过以上设置，硬件固件即可开箱连到你本地部署的后端，实现完全自主管控。

---

如需更换部署主机或 IP，请同步更新：

1. 数据库 `server.websocket`、`server.ota`
2. Python `data/.config.yaml` 中的 `vision_explain`
3. 若使用公网域名，建议在 Nginx 层配置 TLS，再修改上述参数。
